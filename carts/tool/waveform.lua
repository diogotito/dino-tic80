-- title:   game title
-- author:  mimi, pati, tito, tomi
-- desc:    helper to procedurally generate some waveforms
-- license: MIT License
-- version: 0.1
-- script:  lua

-------------------------------------
-- WAVES TO GENERATE  (Edit here!) --
-------------------------------------

WAVES = {
	
	-- #08: Sine wave
	[ 8] = function (x)
		return sin(TWO_PI * x)
	end,	
	
	-- #09: Cosine wave
	[ 9] = function (x)
		return cos(TWO_PI * x)
	end,

}

-------------------------------------


-- Maths shorthands

PI = math.pi
TAU,TWO_PI = 2*math.pi,2*math.pi
sin,cos,tan = math.sin,math.cos,math.tan

function round(x)
	local _i, fract = math.modf(x)
	local rnd = fract < 0.5 and "floor" or "ceil"
	return math[rnd](x)
end

function clamp(value, min, max)
	return math.min(math.max(value, min), max)
end


-- Write a waveform
--   id - which wave (ID from 0 to 15)
--   fn : [0,1] -> [-1,1]
function gen_wave(id, fn)
	local WAVE_ADDR = 0x0FFE4 + 0x10*id
	
	for x = 0, 32 do
		local ret = fn(x/32)
		local val = (ret + 1) * 8
		val = round(val)
		val = clamp(val, 0, 15)
		poke(2*WAVE_ADDR + x, val, 4)
		
		local fmt = ({
			[0] = " f(%2d/16) = %+.5f",
			[1] = " f(%2d/16) = %+.5f   [0x%X]=%2d",
		})[x%2]
		trace(fmt:format(x, ret, WAVE_ADDR+x, val))
	end
end


function BOOT()
	local ids = {}
	for id, fn in pairs(WAVES) do
		trace("-- Generating waveform #"..id.." --", 7)
		gen_wave(id, fn)
		table.insert(ids, id)
		trace("-- Waveform #"..id.." generated --\n", 7)
	end
	
	-- Write waveforms to cartridge SFX data
	local SYNC_SFX = 1 << 3
	sync(SYNC_SFX, 0, true)
	trace("Wave(s) #"..table.concat(ids, ", #").." written to cart :)", 6)
	trace [[
 * Press F4 / Alt+4 to check them
   * These are globally copy-pastable!
   * Or you can pull all SFXs like this
     > load <another>
     > load <this> sfx

 * Don't forget to save!
	]]
end


-- Stay in the command line
TIC = exit

-- <TILES>
-- 002:0000000000000000000000000000700000007000007070000007777700077000
-- 003:0000000000000000000000000000000000000700000007007700070000000777
-- 004:0000000000000000000000000000700000000000000000000000000000000000
-- 005:0000000000000000000000000000000000000000000000000000000000077000
-- 006:0000000000000000000000000000000000000000000000000000000000000070
-- 018:0007000000077000000077000000007700000000000000000000000000000000
-- 019:0000077700707700000770007770700000000000000000000000000000000000
-- 020:0000700070007000070070000700700000707000000077000000000000000000
-- 021:0007070000700000007700000007700000007000000770007777000000000000
-- 022:0000000000000000000000000000000700000007000000070000000700000007
-- 023:0000000000000000000000000000000000077700000707000007000000070000
-- 038:0000000700000007000000700000000000000000000000000000000000000000
-- 039:0007770000000770007000070070000700077770000000000000000000000000
-- 040:0000000700000007000000700000000700000000000000000000000000000000
-- 041:7700000007700000007000000770000077000000070000000700000000700700
-- 057:0077770000000000000000000000000000000000000000000000000000000000
-- 066:0000077700000777000000070000000000000000000000000000000000000000
-- 067:0000000077777777777777777700000077000000770000007700000077000000
-- 068:0000000070000000700007770000777700007777007770070077700707770007
-- 069:0000000000000000000000000000000070000000700000007000000770000077
-- 070:0000000000000000000000000000000000000000077770007777700077077700
-- 071:0000000000000000000000000000000000000000000000000000000000007700
-- 083:7700000000000000000000000000000000000000000000000000000000000000
-- 084:0770000707700077077707770077777000077700000000000000000000000000
-- 085:7000077770007770000077000000770000007777000007770000000700000000
-- 086:0000770000007770000007700000777000777700777777007770000000000000
-- 087:0000770000077700000770000007700000077000007770000077000000777777
-- 088:0000000000000000000000000000000000000000000000000000000077777770
-- 103:0077777700000000000000000000000000000000000000000000000000000000
-- 104:7777777000000000000000000000000000000000000000000000000000000000
-- </TILES>

-- <MAP>
-- 002:002030405060708090000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 003:002131415161718191000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 004:002232425262728292000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 005:002333435363738393000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 006:002434445464748494000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 007:002535455565758595000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- </MAP>

-- <WAVES>
-- 000:00000000ffffffff00000000ffffffff
-- 001:0123456789abcdeffedcba9876543210
-- 002:0123456789abcdef0123456789abcdef
-- 008:8abcefffffffecba8654211000112456
-- 009:ffffecba86542110001124568abcefff
-- 010:fbcdeeffffeedcb96432110000112346
-- </WAVES>

-- <SFX>
-- 000:080008000800080008001800280048008800c800d800e800e800f800f800f800f800f800f800f800f800f800f800f800f800f800f800f800f800f800400000000000
-- 001:090009000900090009000900090009000900090009000900090009000900090009000900090009000900090009000900090009000900090009000900300400000000
-- </SFX>

-- <TRACKS>
-- 000:100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- </TRACKS>

-- <PALETTE>
-- 000:1a1c2c5d275db13e53ef7d57ffcd75a7f07038b76425717929366f3b5dc941a6f673eff7f4f4f494b0c2566c86333c57
-- </PALETTE>

