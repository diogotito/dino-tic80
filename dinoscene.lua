-- title:   dinoscene
-- desc:    gwaaaaaaarrgh
-- site:    diogotito.neocities.org
-- license: your mom
-- version: -3.1415926535...
-- script:  lua



-------------------------------------
-- GAME CONSTANTS                  --
-------------------------------------

local GROUND_Y = 6



-------------------------------------
-- UTILITIES AND TIC-80 CONSTANTS  --
-------------------------------------

local RAM = {
	PALETTE        = 0x3FC0,
	SCREEN_OFFSET  = 0x3FF9,
}


--
-- TIC-80 utility functions
--

local function offset_screen(ox, oy)
	poke(RAM.SCREEN_OFFSET+0, ox or 0)
	poke(RAM.SCREEN_OFFSET+1, oy or 0)
end



-------------------------------------
-- MAP GEN                         --
-------------------------------------

local DIRT_BASE = 16

for cy = 6,16 do
	for cx = 0,30 do
		poke( 0x8000 + 0xF0 * cy + cx
		    , DIRT_BASE + (cx+cy) % 2)
	end
end

for i = 1,8 do
	local tx = math.random(1, 16)
	local ty = math.random(8, 16)
		poke(0x8000 + 0xF0 * ty + tx, 32)
end

-- Justify inclusion of a jet pack
do
	local function pit(x, d)
		for cy = 6, 5+d do
			poke( 0x8000 + cy*0xF0 + x
			    , DIRT_BASE + 2)
		end
		poke(0x8000+(6+d)*0xF0+x,DIRT_BASE+3)
	end
	pit(18, 0)
	pit(23, 7) pit(24, 6) pit(25, 7)
end


-------------------------------------
-- GAME STATE                      --
-------------------------------------

chan = {false, false, false, false}

function update_channels()
	poke(0x14000, chan[1] and 0xFF or 0)
	poke(0x14001, chan[2] and 0xFF or 0)
	poke(0x14002, chan[3] and 0xFF or 0)
	poke(0x14003, chan[4] and 0xFF or 0)
end

function music_row()
	return peek(0x13FFC+2)
end

bar, new_bar = 0, true

function update()
	update_channels()
	if music_row() == 0 then
		if not new_bar then
			bar, new_bar = bar + 1, true
		end
	elseif music_row() ~= 255 then
		new_bar = false
	end
	poke(0x3FF8, music_row())
end


function draw_overlay()
	vbank(1)
	cls()
	print(bar)
	
	local m
	m=music_row()
	vbank(m >= 8 and 1 or 0)
	m=m*(m<8 and 1 or 2)
	for i=1,m do
		trib(math.random(240),
		     math.random(136),
			 			math.random(240),
		     math.random(136),
					 	math.random(240),
		     math.random(136),
						 math.random(16))
	end
	
	vbank(0)
end

-------------------------------------
-- GAME LOOP                       --
-------------------------------------

t=0

function BOOT()
	activate_channels(false, false, false, false)
	music(0)
end

-- try to justify the "scene" part
-- of the cartridge name
function BDR(scanline)
	-- palette fuckery
	local col = 1-(t/30)*190
	poke(0x3FDB, col-1.1*scanline)
	poke(0x3FDC, col-1.2*scanline+t)
	poke(0x3FDD, col-2*scanline)
	-- wavy raster effects
	local ox = 10 * math.sin(
	            0.1 * (scanline  + 2*t))
	local oy = 6 * math.cos(
	            0.07 * (scanline + 2*t))
	if music_row() >= 8 then
		ox = ox * (1-(t % 110 / 15))
		oy = 136-(t%110/35)*scanline-oy
	else
		ox = ox + (2-math.pow(2,bar%8))*t
	end
	offset_screen(ox, oy)
end

function TIC()
	--------- update ----------
	
	update()
	
	---------- draw -----------
	
	vbank(0)
	
	-- dirt
	map()
	-- the sun
	circ(230, 0, 20, 4)
	-- dino
	spr(48, 20, 24, 0, 1, 0, 0, 3, 3)
	line(42, 32, 55, 26, 0)
	-- dude
	spr(83, 120, 40, 15)
	print("gwaaaaaaarrgh", 56, 20, 0)		
	draw_overlay()
	
	--------- advance t ----------
	
	t = t + 1
end
-- <TILES>
-- 000:9999999999999999999999999999999999999999999999999999999999999999
-- 001:9999999999999999999999999999999999999999999999999999999999999999
-- 016:1111111111111111166216612662261221112622111112211611661116111111
-- 017:1111111111266111222221112111221216111222166111211611111111111161
-- 018:0000000000200000000001000000000000000000001000000000001000000000
-- 019:0000000000001000000000000070007000700070076703670367076776633666
-- 032:9818111199111891911919191111111119119119981981911911911991111191
-- 033:1111111111111111111111111111111111111111111111111111111111111111
-- 049:0000000000000000000000000000000000006666000660660006666600066666
-- 050:0000000000000000000000000000000066600000666600006666000066660000
-- 064:0000000060000000600000006600006666600666666666666666666606666666
-- 065:0006666600666666666666606666666666666600666666006666666666666606
-- 066:6666000066660000000000006600000000000000000000000000000000000000
-- 080:0066666600066666000066660000066600000666000006600000060000000660
-- 081:6666660066666600666660006666000006600000006000000060000000660000
-- 083:f35555ff3f3333fff555555fff6060ffff6666fff63222ffff22225ff5ffffff
-- 084:ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff
-- 099:0055550000444400055555500066660000166100043113407033330700500500
-- </TILES>

-- <WAVES>
-- 000:00000000ffffffff00000000ffffffff
-- 001:0123456789abcdeffedcba9876543210
-- 002:0123456789abcdef0123456789abcdef
-- 004:0000000fffee0000000000effffff000
-- 005:1469cfb952027adfca862068adfd9520
-- 006:0123456789abcdef0123456789abcdef
-- </WAVES>

-- <SFX>
-- 000:d600a60256014600460e360e3600360036003600360f360f36003600360f360f360f360f26002600260026002600160016001600160026009600e600429000000100
-- 001:0593258445836581857da57cd57b656c756d955fb551e541a541c530e53ff53dd53be52be52ef521f512e512f511f510f51ff50ef50ff50ff50df50b202000000000
-- 002:15c405c405f305f3153515f515f3159315c3152415e415e215e1151215e215f315e315e115e115e115e215e3150415e415f415ee15e915f815ee15e472b000000000
-- 003:060006010602060406050605160516042602260136004600560076009600a600b600c600d600d600e600e600f600f600f600f600f600f600f600f600070000000016
-- 016:2f000f000f000f000f000f000f000f000f000f000f001f001f003f008f00cf00cf00cf00ef00ef00ff00ff00ff00ff00ff00ff00ff00ff00ff00ff00032000000000
-- </SFX>

-- <PATTERNS>
-- 000:077100000000c90508000000000000000000c00008000000000000000000c00008000000000000000000c00008000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 001:6ff114000000000000000000ba811400000000000000000068a1140000000000000000006ff11a000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 002:4ff130000000000000000000000000000020000100f8854e0241000841000ee100021100010100000100000500000200000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- 003:900007084500c88106000000900009000000c00006000001900007000000c00006000000900009100001c00006000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
-- </PATTERNS>

-- <TRACKS>
-- 000:180301000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000500300
-- </TRACKS>

-- <PALETTE>
-- 000:2f2a35443d386256539a5d40a981433b42626f7777989da0c2b8a9d9dbba000404ffffff000000000000000000000000
-- </PALETTE>

